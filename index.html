<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گزارش جامع مالی ۱۸ ماهه - ساختمان نگین زمرد</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f0f4f8;
        }
        html {
            scroll-behavior: smooth;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        #expense-chart-container {
            height: 320px;
        }
        @media (min-width: 768px) {
            #expense-chart-container {
                height: 350px;
            }
        }
        #debt-chart-container {
             height: 550px;
        }
        #cumulative-chart-container {
            height: 350px;
            max-height: 420px;
        }
        .rtl-grid {
            direction: rtl;
        }
        .kpi-value {
            font-size: 2.2rem;
            line-height: 2.8rem;
            font-weight: 700;
            color: #003f5c;
        }
        .kpi-label {
            font-size: 1.1rem;
            color: #7a5195;
        }
        .bilan-card {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .bilan-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #003f5c;
            text-align: center;
            margin-bottom: 1rem;
        }
        .bilan-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .bilan-item:last-child {
            border-bottom: none;
        }
        .bilan-label {
            font-weight: 500;
            color: #4b5563;
        }
        .bilan-value {
            font-weight: 700;
        }
        .nav-link {
            @apply text-gray-700 hover:text-[#003f5c] font-semibold px-8 py-2 transition-colors duration-300;
        }
        .animate-on-scroll {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .animate-on-scroll.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="sticky top-0 bg-white/80 backdrop-blur-sm shadow-md z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-center items-center h-16 gap-x-10">
                <a href="#bilan" class="nav-link">بیلان کلی</a>
                <a href="#charge-debt" class="nav-link">بدهی شارژ</a>
                <a href="#cumulative-trend" class="nav-link">نمودار درآمد و هزینه</a>
                <a href="#sewage-project" class="nav-link">اقساط فاضلاب</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-10 animate-on-scroll">
            <h1 class="text-4xl md:text-5xl font-bold text-[#003f5c]">بیلان عملکرد تجمعی ساختمان نگین زمرد</h1>
            <p class="text-xl text-gray-600 mt-2">دوره ۱۸ ماهه: فروردین ۱۴۰۳ لغایت شهریور ۱۴۰۴</p>
        </header>

        <section id="bilan" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 text-center mb-12 rtl-grid animate-on-scroll">
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center">
                <p class="kpi-value" id="total-income">۳٬۷۲۱٬۵۳۰٬۰۰۰</p>
                <p class="kpi-label">مجموع درآمد تجمعی (ریال)</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center">
                <p class="kpi-value" id="total-expense">۳٬۶۳۳٬۳۳۰٬۴۵۷</p>
                <p class="kpi-label">مجموع هزینه تجمعی (ریال)</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center">
                <p class="kpi-value text-green-600" id="net-balance">۸۸٬۱۹۹٬۵۴۳</p>
                <p class="kpi-label">مانده حساب کل (ریال)</p>
            </div>
             <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center">
                <p class="kpi-value text-red-500" id="total-debt">۱٬۰۳۰٬۴۷۰٬۰۰۰</p>
                <p class="kpi-label">کل بدهی تجمعی (ریال)</p>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12 rtl-grid animate-on-scroll">
            <div class="bilan-card">
                <h3 class="bilan-title">بیلان سال مالی ۱۴۰۳</h3>
                <div class="bilan-item">
                    <span class="bilan-label">درآمد محقق شده:</span>
                    <span class="bilan-value text-green-700">۲٬۶۲۹٬۵۳۰٬۰۰۰</span>
                </div>
                <div class="bilan-item">
                    <span class="bilan-label">هزینه‌های ثبت شده:</span>
                    <span class="bilan-value text-red-700">۱٬۱۹۴٬۰۴۹٬۴۵۷</span>
                </div>
                <div class="bilan-item">
                    <span class="bilan-label">مانده پایان سال:</span>
                    <span class="bilan-value text-green-700">۱٬۴۳۵٬۴۸۰٬۵۴۳</span>
                </div>
            </div>
            <div class="bilan-card">
                <h3 class="bilan-title">بیلان شش ماهه اول ۱۴۰۴</h3>
                <div class="bilan-item">
                    <span class="bilan-label">درآمد محقق شده:</span>
                    <span class="bilan-value text-green-700">۱٬۰۹۲٬۰۰۰٬۰۰۰</span>
                </div>
                <div class="bilan-item">
                    <span class="bilan-label">هزینه‌های ثبت شده:</span>
                    <span class="bilan-value text-red-700">۲٬۴۳۹٬۲۸۱٬۰۰۰</span>
                </div>
                <div class="bilan-item">
                    <span class="bilan-label">مانده دوره:</span>
                    <span class="bilan-value text-red-700">(۱٬۳۴۷٬۲۸۱٬۰۰۰)</span>
                </div>
            </div>
        </section>

        <main id="charge-debt" class="grid grid-cols-1 lg:grid-cols-3 gap-8 rtl-grid animate-on-scroll">

            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-1 text-center text-[#003f5c]">سهم هر هزینه از کل مخارج (۱۸ ماهه)</h2>
                <p class="text-center text-gray-600 mb-4">حقوق، نگهداری و هزینه‌های مربوط به تاسیسات (آسانسور، پمپ و...) عمده مخارج ساختمان را تشکیل داده‌اند.</p>
                <div id="expense-chart-container" class="chart-container">
                    <canvas id="expenseDoughnutChart"></canvas>
                </div>
            </div>
            
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-1 text-center text-[#003f5c]">تفکیک بدهی تجمعی واحدها تا شهریور ۱۴۰۴</h2>
                <p class="text-center text-gray-600 mb-4">میزان کل بدهی معوقه ساکنین به صندوق ساختمان تا پایان این دوره، مبلغ <span class="text-red-600 font-bold">۱٬۰۳۰٬۴۷۰٬۰۰۰</span> ریال می‌باشد.</p>
                 <div id="debt-chart-container" class="chart-container">
                     <canvas id="debtBarChart"></canvas>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-bold text-center text-gray-700 mb-3">واحدهای با بیشترین بدهی معوقه شارژ</h3>
                    <ul id="top-debtors-list" class="divide-y divide-gray-200">
                        <!-- List will be populated by script -->
                    </ul>
                </div>
            </div>
            
            <div id="cumulative-trend" class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg mt-8 animate-on-scroll">
                <h2 class="text-2xl font-bold mb-1 text-center text-[#003f5c]">روند درآمد و هزینه تجمعی ماهانه (۱۸ ماهه)</h2>
                <p class="text-center text-green-700 font-semibold text-lg mb-4">موجودی نهایی صندوق در پایان دوره: ۸۸٬۱۹۹٬۵۴۳ ریال</p>
                 <div id="cumulative-chart-container" class="chart-container">
                     <canvas id="cumulativeTrendChart"></canvas>
                </div>
            </div>

        </main>

        <hr class="my-12 border-t-2 border-gray-300">

        <section id="sewage-project" class="mt-8 animate-on-scroll">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-bold text-[#003f5c]">گزارش مالی وضعیت دریافت و پرداخت اقساط انشعاب فاضلاب</h1>
            </header>
    
            <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 text-center mb-12 rtl-grid max-w-5xl mx-auto">
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center">
                    <p class="kpi-value" id="sewage-collected">۳٬۵۰۸٬۰۴۰٬۰۰۰</p>
                    <p class="kpi-label">کل وصولی از ساکنین (ریال)</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center">
                    <p class="kpi-value" id="sewage-paid">۳٬۳۲۰٬۷۶۱٬۱۱۱</p>
                    <p class="kpi-label">کل پرداختی به اداره آب (ریال)</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center">
                    <p class="kpi-value text-red-500" id="sewage-debt-total">۱۱۲٬۰۳۰٬۰۰۰</p>
                    <p class="kpi-label">بدهی معوقه ساکنین (ریال)</p>
                </div>
            </section>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-1 text-center text-[#003f5c]">واحدهای بدهکار در پروژه فاضلاب</h2>
                <p class="text-center text-gray-600 mb-4">تعهد پرداخت ساکنین تا این تاریخ شامل پیش‌پرداخت و ۹ قسط می‌باشد. نمودار زیر توزیع بدهی معوقه را بین واحدهای بدهکار نمایش می‌دهد.</p>
                 <div id="sewage-chart-container" class="chart-container">
                     <canvas id="sewageDebtChart"></canvas>
                </div>
            </div>
        </section>

    </div>
    
    <footer class="text-center py-6 mt-8 bg-gray-200 relative">
        <p class="text-gray-600">توسعه داده شده توسط امیررضا اعطاسی</p>
        <a href="#" onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;" class="absolute right-4 md:right-10 top-1/2 -translate-y-1/2 bg-[#003f5c] text-white rounded-full h-12 w-12 flex items-center justify-center text-2xl hover:bg-[#7a5195] transition-colors shadow-lg" aria-label="برو به بالای صفحه">
            &#9650;
        </a>
    </footer>


    <script>
        Chart.register(ChartDataLabels);

        const formatRial = (num) => {
            if (num < 0) {
                return `(${Math.abs(num).toLocaleString('fa-IR')})`;
            }
            return num.toLocaleString('fa-IR');
        };
        
        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
                return label.join(' ');
            }
            return label;
        };
        
        const tooltipLabelCallback = (context) => {
            let label = context.dataset.label || '';
            if (label) {
                label += ': ';
            }
            if (context.parsed.y !== null) {
                label += formatRial(context.parsed.y) + ' ریال';
            }
            return label;
        };

        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        title: tooltipTitleCallback,
                        label: tooltipLabelCallback
                    },
                    bodyFont: { family: 'Vazirmatn' },
                    titleFont: { family: 'Vazirmatn' },
                    rtl: true,
                },
                legend: {
                    labels: {
                        font: {
                            family: 'Vazirmatn',
                            size: 12
                        }
                    }
                },
                datalabels: {
                   display: false 
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                             if (value >= 1.0e9) {
                                return (value / 1.0e9).toFixed(1) + 'میلیارد';
                            }
                            if (value >= 1.0e6) {
                                return (value / 1.0e6).toFixed(0) + 'میلیون';
                            }
                            return formatRial(value);
                        },
                        font: { family: 'Vazirmatn' }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        font: { family: 'Vazirmatn', size: 10 }
                    },
                     grid: {
                        display: false
                    }
                }
            }
        };

        const expenseData = {
            labels: ['حقوق و نگهداری', 'هزینه های تاسیسات', 'قبوض خدماتی', 'هزینه های عمرانی', 'متفرقه'],
            datasets: [{
                label: 'هزینه',
                data: [1418900000, 1094860200, 620650800, 316000000, 182919457],
                backgroundColor: ['#003f5c', '#7a5195', '#d34b97', '#ff666e', '#ffa600'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        };

        const expenseDoughnutCtx = document.getElementById('expenseDoughnutChart').getContext('2d');
        new Chart(expenseDoughnutCtx, {
            type: 'doughnut',
            data: expenseData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: tooltipTitleCallback,
                            label: (context) => {
                                let value = context.parsed;
                                let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value / total * 100).toFixed(1);
                                return `${formatRial(value)} ریال (${percentage}%)`;
                            }
                        },
                         bodyFont: { family: 'Vazirmatn' },
                         titleFont: { family: 'Vazirmatn' },
                         rtl: true,
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { family: 'Vazirmatn', size: 11 },
                            boxWidth: 15
                        }
                    },
                    datalabels: {
                        display: false
                    }
                }
            }
        });
        
        const debtData = {
            labels: ['واحد ۱', 'واحد ۲', 'واحد ۶', 'واحد ۷', 'واحد ۸', 'واحد ۹', 'واحد ۱۱', 'واحد ۱۲', 'واحد ۱۴', 'واحد ۱۵', 'واحد ۱۶', 'واحد ۱۸', 'واحد ۱۹', 'واحد ۲۰', 'واحد ۲۱', 'واحد ۲۳', 'واحد ۲۴', 'واحد ۲۵', 'واحد ۲۶', 'واحد ۲۸', 'واحد ۳۰', 'واحد ۳۴', 'واحد ۳۵', 'واحد ۳۶'],
            datasets: [
                {
                    label: 'بدهی سال ۱۴۰۳',
                    data: [42000000, 14000000, 0, 0, 60000000, 0, 0, 0, 9000000, 24000000, 0, 16000000, 0, 0, 19470000, 0, 0, 84000000, 0, 0, 0, 42000000, 0, 84000000],
                    backgroundColor: '#003f5c',
                    borderRadius: 5,
                },
                {
                    label: 'بدهی سال ۱۴۰۴',
                    data: [48000000, 0, 8000000, 16000000, 48000000, 8000000, 8000000, 8000000, 16000000, 20000000, 8000000, 48000000, 8000000, 48000000, 48000000, 48000000, 16000000, 16000000, 8000000, 16000000, 48000000, 48000000, 48000000, 48000000],
                    backgroundColor: '#7a5195',
                    borderRadius: 5,
                }
            ]
        };

        const debtBarCtx = document.getElementById('debtBarChart').getContext('2d');
        new Chart(debtBarCtx, {
            type: 'bar',
            data: debtData,
            options: {
                 indexAxis: 'y',
                 responsive: true,
                maintainAspectRatio: false,
                plugins: {
                     tooltip: {
                        callbacks: {
                           title: tooltipTitleCallback,
                           label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.x !== null) {
                                    label += formatRial(context.parsed.x) + ' ریال';
                                }
                                return label;
                           }
                         },
                         bodyFont: { family: 'Vazirmatn' },
                         titleFont: { family: 'Vazirmatn' },
                         rtl: true,
                    },
                    legend: {
                       display: true,
                       position: 'top',
                       labels: {
                           font: { family: 'Vazirmatn', size: 12 }
                       }
                    },
                    datalabels: {
                       display: false
                    }
                },
                 scales: {
                    y: {
                        ticks: { 
                            font: { family: 'Vazirmatn', size: 9 }
                        },
                        grid: { display: false },
                        stacked: true,
                    },
                    x: {
                        ticks: { 
                            callback: function(value) {
                                return formatRial(value / 1000000) + 'م';
                            },
                            font: { family: 'Vazirmatn' } 
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        stacked: true
                    }
                }
            }
        });
        
        const topDebtors = debtData.labels.map((label, index) => {
            const totalDebt = debtData.datasets[0].data[index] + debtData.datasets[1].data[index];
            return { unit: label, totalDebt: totalDebt };
        }).filter(item => item.totalDebt > 0)
          .sort((a, b) => b.totalDebt - a.totalDebt)
          .slice(0, 7);

        const listElement = document.getElementById('top-debtors-list');
        topDebtors.forEach(debtor => {
            const listItem = document.createElement('li');
            listItem.className = 'flex justify-between items-center py-3 px-2';
            listItem.innerHTML = `<span class="font-semibold text-gray-800">${debtor.unit}</span><span class="font-bold text-red-500">${formatRial(debtor.totalDebt)} ریال</span>`;
            listElement.appendChild(listItem);
        });


        const cumulativeTrendData = {
            labels: ['فروردین ۰۳', 'اردیبهشت ۰۳', 'خرداد ۰۳', 'تیر ۰۳', 'مرداد ۰۳', 'شهریور ۰۳', 'مهر ۰۳', 'آبان ۰۳', 'آذر ۰۳', 'دی ۰۳', 'بهمن ۰۳', 'اسفند ۰۳', 'فروردین ۰۴', 'اردیبهشت ۰۴', 'خرداد ۰۴', 'تیر ۰۴', 'مرداد ۰۴', 'شهریور ۰۴'],
            datasets: [
                {
                    label: 'درآمد تجمعی',
                    data: [198000000, 399000000, 603000000, 807000000, 999000000, 1185000000, 1435000000, 1681000000, 1927000000, 2169530000, 2399530000, 2629530000, 2827530000, 3025530000, 3233530000, 3441530000, 3609530000, 3721530000],
                    borderColor: '#003f5c',
                    backgroundColor: 'rgba(0, 63, 92, 0.1)',
                    fill: true,
                    tension: 0.1
                },
                {
                    label: 'هزینه تجمعی',
                    data: [0, 0, 0, 76715000, 181385000, 266085000, 350613200, 465086657, 722209657, 946663657, 1038928657, 1194049457, 2296999457, 2566024457, 2810020457, 3108672457, 3328172457, 3633330457],
                    borderColor: '#ff666e',
                    backgroundColor: 'rgba(255, 102, 110, 0.1)',
                    fill: true,
                    tension: 0.1
                }
            ]
        };
        const cumulativeTrendCtx = document.getElementById('cumulativeTrendChart').getContext('2d');
        new Chart(cumulativeTrendCtx, {
            type: 'line',
            data: cumulativeTrendData,
            options: defaultChartOptions
        });

        // --- New Sewage Chart ---
        const sewageDebtData = {
            labels: ['واحد ۱', 'واحد ۲', 'واحد ۳', 'واحد ۴', 'واحد ۶', 'واحد ۷', 'واحد ۸', 'واحد ۱۴', 'واحد ۱۶', 'واحد ۲۱', 'واحد ۲۳', 'واحد ۲۴', 'واحد ۳۰', 'واحد ۳۴', 'واحد ۳۵', 'واحد ۳۶'],
            datasets: [{
                label: 'بدهی قسط فاضلاب',
                data: [6590000, 6590000, 6590000, 6590000, 6590000, 6590000, 13180000, 6590000, 6590000, 6590000, 6590000, 6590000, 6590000, 6590000, 6590000, 6590000],
                backgroundColor: '#d34b97',
                borderRadius: 5,
                borderWidth: 0
            }]
        };
        
        const sewageChartContainer = document.getElementById('sewage-chart-container');
        sewageChartContainer.style.height = `${sewageDebtData.labels.length * 28}px`;


        const sewageDebtCtx = document.getElementById('sewageDebtChart').getContext('2d');
        new Chart(sewageDebtCtx, {
            type: 'bar',
            data: sewageDebtData,
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        right: 70 
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: tooltipTitleCallback,
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.x !== null) {
                                    label += formatRial(context.parsed.x) + ' ریال';
                                }
                                return label;
                            }
                        },
                        bodyFont: { family: 'Vazirmatn' },
                        titleFont: { family: 'Vazirmatn' },
                        rtl: true,
                    },
                    legend: {
                       display: false
                    },
                    datalabels: {
                        formatter: (value) => {
                           if (value > 0) {
                                return formatRial(value);
                           }
                           return '';
                        },
                        color: '#333',
                        font: {
                            size: 9,
                            weight: 'bold',
                            family: 'Vazirmatn'
                        },
                        anchor: 'end',
                        align: 'start',
                        offset: 8
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: function(value) {
                                return formatRial(value / 1000000) + 'م';
                            },
                            font: { family: 'Vazirmatn' }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    y: {
                        ticks: { font: { family: 'Vazirmatn', size: 10 } },
                        grid: { display: false }
                    }
                }
            }
        });

        // --- Animation on Scroll ---
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, {
            threshold: 0.1
        });

        const elementsToAnimate = document.querySelectorAll('.animate-on-scroll');
        elementsToAnimate.forEach(el => observer.observe(el));


    </script>
</body>
</html>



